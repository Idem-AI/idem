name: CI/CD - npm workspaces

on:
  push:
    branches: [main, develop, dev, master]
  pull_request:
    branches: [main, develop, dev, master]

permissions:
  contents: read
  pages: write
  id-token: write

env:
  NODE_VERSION: '18.x'

jobs:
  # ==========================
  # 1Ô∏è‚É£ Detect changes
  # ==========================
  detect-changes:
    name: üîç Detect Changed Applications
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      main-app: ${{ steps.filter.outputs.main-app }}
      chart: ${{ steps.filter.outputs.chart }}
      appgen: ${{ steps.filter.outputs.appgen }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            api:
              - 'apps/api/**'
            main-app:
              - 'apps/main-app/**'
            chart:
              - 'apps/chart/**'
            appgen:
              - 'apps/appgen/**'

  # ==========================
  # 2Ô∏è‚É£ Quality checks
  # ==========================
  quality:
    name: ‚úÖ Quality Checks
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api == 'true' ||
      needs.detect-changes.outputs.main-app == 'true' ||
      needs.detect-changes.outputs.chart == 'true' ||
      needs.detect-changes.outputs.appgen == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false

      # Cache PNPM store (corrected output format)
      - name: Get PNPM store path
        id: pnpm-store
        run: |
          STORE_PATH=$(pnpm store path)
          echo "STORE_PATH<<EOF" >> $GITHUB_OUTPUT
          echo "$STORE_PATH" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Cache PNPM store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Cache ESLint
      - name: Cache ESLint
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('**/*.ts', '**/*.tsx', '**/*.js', '**/*.jsx') }}
          restore-keys: |
            ${{ runner.os }}-eslint-

      - name: Run Prettier format check
        run: pnpm run format:check

      - name: Run ESLint
        run: pnpm run lint:all -- --cache --cache-location .eslintcache

      # Uncomment if you enable tests
      # - name: Run tests
      #   run: pnpm run test:all
      #
      # - name: Upload test coverage
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: test-coverage
      #     path: '**/coverage'
      #     retention-days: 7

  # ==========================
  # 3Ô∏è‚É£ Deploy jobs
  # ==========================
  deploy-api:
    name: üöÄ Deploy API
    needs: [detect-changes, quality]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev') &&
      needs.detect-changes.outputs.api == 'true'
    uses: ./.github/workflows/deploy-api.yml
    secrets: inherit

  deploy-main-app:
    name: üöÄ Deploy Main App
    needs: [detect-changes, quality]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev') &&
      needs.detect-changes.outputs.main-app == 'true'
    uses: ./.github/workflows/deploy-main-app.yml
    secrets: inherit

  deploy-chart:
    name: üöÄ Deploy Chart
    needs: [detect-changes, quality]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.detect-changes.outputs.chart == 'true'
    uses: ./.github/workflows/deploy-chart.yml
    secrets: inherit

  # ==========================
  # 4Ô∏è‚É£ Summary
  # ==========================
  summary:
    name: üìä CI/CD Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, quality, deploy-api, deploy-main-app, deploy-chart]
    if: always()
    steps:
      - name: Display CI/CD Summary
        run: |
          echo "## üìä CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected:" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: ${{ needs.detect-changes.outputs.api == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Main App**: ${{ needs.detect-changes.outputs.main-app == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart**: ${{ needs.detect-changes.outputs.chart == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AppGen**: ${{ needs.detect-changes.outputs.appgen == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployments:" >> $GITHUB_STEP_SUMMARY
          echo "- **API**: ${{ needs.deploy-api.result == 'success' && '‚úÖ Deployed' || (needs.deploy-api.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Main App**: ${{ needs.deploy-main-app.result == 'success' && '‚úÖ Deployed' || (needs.deploy-main-app.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Chart**: ${{ needs.deploy-chart.result == 'success' && '‚úÖ Deployed' || (needs.deploy-chart.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed') }}" >> $GITHUB_STEP_SUMMARY
