version: '3.8'

services:
  # IDEM Frontend - Production Environment
  idem: 
    image: ghcr.io/idem-ai/idem-main-dashboard:1.0
    container_name: idem
    restart: always
    networks:
      - idem
    labels:
      - "environment=production"

  # IDEM Landing - Production Environment
  idem-landing: 
    image: ghcr.io/idem-ai/idem-landing:ee3d663e
    container_name: idem-landing
    restart: always
    networks:
      - idem
    labels:
      - "environment=production"

  # IDEM API - Production Environment
  idem-api:
    image: ghcr.io/idem-ai/idem-api:28d44d3e
    container_name: idem-api
    environment:
      DEEPSEEK_API_KEY: "${DEEPSEEK_API_KEY}"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      PORT: "${PORT}"
      FIREBASE_API_KEY: "${FIREBASE_API_KEY}"
      FIREBASE_AUTH_DOMAIN: "${FIREBASE_AUTH_DOMAIN}"
      FIREBASE_PROJECT_ID: "${FIREBASE_PROJECT_ID}"
      FIREBASE_STORAGE_BUCKET: "${FIREBASE_STORAGE_BUCKET}"
      FIREBASE_MESSAGING_SENDER_ID: "${FIREBASE_MESSAGING_SENDER_ID}"
      FIREBASE_APP_ID: "${FIREBASE_APP_ID}"
      FIREBASE_PRIVATE_KEY: "${FIREBASE_PRIVATE_KEY}"
      FIREBASE_CLIENT_EMAIL: "${FIREBASE_CLIENT_EMAIL}"
      CORS_ALLOWED_ORIGINS: "https://api.idem-ai.com,https://webgen.idem-ai.com,https://appgen.idem-ai.com,http://chart.idem-ai.com,https://idem-ai.com,https://api.idem.africa,https://appgen.idem.africa,https://console.idem.africa"
      REDIS_HOST: "redis-prod"
      REDIS_PORT: "6379"
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
    ports:
      - "${PORT}:${PORT}"
    restart: unless-stopped
    depends_on:
      - redis-prod
    networks:
      - idem
    labels:
      - "environment=production"

  # IDEM WebGen - Production Environment
  idem-webgen:
    restart: always
    image: ghcr.io/idem-ai/idem-appgen:v1.0
    container_name: idem-webgen
    env_file:
     - .env
    networks:
      - idem
    labels:
      - "environment=production"

  # AppGen Server - Production Environment
  appgen-server:
    restart: always
    image: appgen-server:2.0
    container_name: appgen-server
    env_file:
      - .env
    networks:
      - idem
    labels:
      - "environment=production"

  # IDEM Chart - Production Environment
  idem-chart:
    image: ghcr.io/idem-ai/idem-chart:v1.0
    container_name: idem-chart
    ports:
      - "8040:8080"
    platform: linux/amd64
    restart: unless-stopped
    networks:
      - idem
    labels:
      - "environment=production"

  # Redis - Production Environment
  redis-prod:
    image: redis:7-alpine
    container_name: redis-prod
    command: redis-server --requirepass "${REDIS_PASSWORD}" --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis-prod-data:/data
    restart: unless-stopped
    networks:
      - idem
    labels:
      - "environment=production"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  redis-prod-data:
    driver: local

networks:
  idem:
    external: true
    name: idem
