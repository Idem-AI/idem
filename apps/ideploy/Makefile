.PHONY: help install start stop restart logs clean test

# Couleurs pour les messages
BLUE := \033[0;34m
GREEN := \033[0;32m
NC := \033[0m # No Color

help: ## Afficher l'aide
	@echo "$(BLUE)Commandes disponibles pour Coolify (mode local):$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-15s$(NC) %s\n", $$1, $$2}'

install: ## Installer et configurer Coolify
	@echo "$(BLUE)ğŸš€ Installation de Coolify...$(NC)"
	./scripts/run-local.sh

start: ## DÃ©marrer tous les services
	@echo "$(BLUE)ğŸš€ DÃ©marrage de tous les services...$(NC)"
	./scripts/start-all.sh

start-dev: ## DÃ©marrer tous les services avec Vite dev server
	@echo "$(BLUE)ğŸš€ DÃ©marrage de tous les services (mode dev)...$(NC)"
	./scripts/start-all.sh --dev

stop: ## ArrÃªter tous les services
	@echo "$(BLUE)ğŸ›‘ ArrÃªt de tous les services...$(NC)"
	./scripts/stop-all.sh

restart: stop start ## RedÃ©marrer tous les services

serve: ## DÃ©marrer uniquement le serveur web
	@echo "$(BLUE)ğŸŒ DÃ©marrage du serveur web...$(NC)"
	php artisan serve --host=0.0.0.0 --port=8000

queue: ## DÃ©marrer le queue worker
	@echo "$(BLUE)âš™ï¸  DÃ©marrage du queue worker...$(NC)"
	php artisan queue:work --tries=3

horizon: ## DÃ©marrer Laravel Horizon
	@echo "$(BLUE)ğŸ”­ DÃ©marrage de Horizon...$(NC)"
	php artisan horizon

dev: ## DÃ©marrer Vite dev server
	@echo "$(BLUE)âš¡ DÃ©marrage de Vite...$(NC)"
	npm run dev

build: ## Compiler les assets pour production
	@echo "$(BLUE)ğŸ¨ Compilation des assets...$(NC)"
	npm run build

logs: ## Afficher les logs Laravel
	@tail -f storage/logs/laravel.log

logs-web: ## Afficher les logs du serveur web
	@tail -f storage/logs/services/web.log

logs-queue: ## Afficher les logs de la queue
	@tail -f storage/logs/services/queue.log

logs-horizon: ## Afficher les logs de Horizon
	@tail -f storage/logs/services/horizon.log

db-migrate: ## ExÃ©cuter les migrations
	@echo "$(BLUE)ğŸ”„ ExÃ©cution des migrations...$(NC)"
	php artisan migrate

db-fresh: ## RÃ©initialiser la base de donnÃ©es
	@echo "$(BLUE)ğŸ—„ï¸  RÃ©initialisation de la base de donnÃ©es...$(NC)"
	php artisan migrate:fresh --seed

db-seed: ## Remplir la base de donnÃ©es
	@echo "$(BLUE)ğŸŒ± Remplissage de la base de donnÃ©es...$(NC)"
	php artisan db:seed

cache-clear: ## Vider tous les caches
	@echo "$(BLUE)ğŸ§¹ Nettoyage des caches...$(NC)"
	php artisan cache:clear
	php artisan config:clear
	php artisan route:clear
	php artisan view:clear

optimize: ## Optimiser l'application
	@echo "$(BLUE)âš¡ Optimisation de l'application...$(NC)"
	php artisan optimize

test: ## ExÃ©cuter les tests
	@echo "$(BLUE)ğŸ§ª ExÃ©cution des tests...$(NC)"
	php artisan test

tinker: ## Ouvrir Laravel Tinker
	@php artisan tinker

clean: ## Nettoyer les fichiers temporaires
	@echo "$(BLUE)ğŸ§¹ Nettoyage...$(NC)"
	rm -rf storage/logs/services/*.log
	rm -rf storage/logs/services/*.pid
	rm -rf bootstrap/cache/*.php

status: ## Afficher le statut des services
	@echo "$(BLUE)ğŸ“Š Statut des services:$(NC)"
	@echo ""
	@if [ -f storage/logs/services/web.pid ]; then \
		PID=$$(cat storage/logs/services/web.pid); \
		if ps -p $$PID > /dev/null 2>&1; then \
			echo "$(GREEN)âœ… Serveur web (PID: $$PID)$(NC)"; \
		else \
			echo "âŒ Serveur web (arrÃªtÃ©)"; \
		fi \
	else \
		echo "âŒ Serveur web (non dÃ©marrÃ©)"; \
	fi
	@if [ -f storage/logs/services/queue.pid ]; then \
		PID=$$(cat storage/logs/services/queue.pid); \
		if ps -p $$PID > /dev/null 2>&1; then \
			echo "$(GREEN)âœ… Queue worker (PID: $$PID)$(NC)"; \
		else \
			echo "âŒ Queue worker (arrÃªtÃ©)"; \
		fi \
	else \
		echo "âŒ Queue worker (non dÃ©marrÃ©)"; \
	fi
	@if [ -f storage/logs/services/horizon.pid ]; then \
		PID=$$(cat storage/logs/services/horizon.pid); \
		if ps -p $$PID > /dev/null 2>&1; then \
			echo "$(GREEN)âœ… Horizon (PID: $$PID)$(NC)"; \
		else \
			echo "âŒ Horizon (arrÃªtÃ©)"; \
		fi \
	else \
		echo "âŒ Horizon (non dÃ©marrÃ©)"; \
	fi
	@echo ""
	@echo "$(BLUE)Services systÃ¨me:$(NC)"
	@brew services list | grep -E "(postgresql@15|redis)" || echo "Aucun service trouvÃ©"

composer-install: ## Installer les dÃ©pendances PHP
	@echo "$(BLUE)ğŸ“¦ Installation des dÃ©pendances PHP...$(NC)"
	composer install

composer-update: ## Mettre Ã  jour les dÃ©pendances PHP
	@echo "$(BLUE)ğŸ“¦ Mise Ã  jour des dÃ©pendances PHP...$(NC)"
	composer update

npm-install: ## Installer les dÃ©pendances Node.js
	@echo "$(BLUE)ğŸ“¦ Installation des dÃ©pendances Node.js...$(NC)"
	npm install

npm-update: ## Mettre Ã  jour les dÃ©pendances Node.js
	@echo "$(BLUE)ğŸ“¦ Mise Ã  jour des dÃ©pendances Node.js...$(NC)"
	npm update
