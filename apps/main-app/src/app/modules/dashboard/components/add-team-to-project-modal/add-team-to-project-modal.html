<p-dialog
  [visible]="visible()"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '42rem', maxHeight: '90vh' }"
  styleClass="glass-card"
  (onHide)="onClose()"
>
  <ng-template pTemplate="header">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <i class="pi pi-users text-primary text-2xl"></i>
        <h2 class="text-2xl font-bold text-white">Add Team to Project</h2>
      </div>
      <p class="text-sm text-gray-400">
        Choose an existing team or create a new one to add to this project
      </p>
    </div>
  </ng-template>

  <!-- Selection Mode Tabs -->
  <div class="border-b border-white/10 mb-4">
    <div class="flex gap-2 p-1 bg-white/5 rounded-lg">
      <button
        (click)="setSelectionMode('existing')"
        [class.bg-primary]="selectionMode() === 'existing'"
        [class.text-white]="selectionMode() === 'existing'"
        [class.text-gray-400]="selectionMode() !== 'existing'"
        class="flex-1 px-4 py-3 rounded-md font-medium transition"
      >
        <i class="pi pi-users mr-2"></i>
        Existing Team
      </button>
      <button
        (click)="setSelectionMode('new')"
        [class.bg-primary]="selectionMode() === 'new'"
        [class.text-white]="selectionMode() === 'new'"
        [class.text-gray-400]="selectionMode() !== 'new'"
        class="flex-1 px-4 py-3 rounded-md font-medium transition"
      >
        <i class="pi pi-plus-circle mr-2"></i>
        Create New Team
      </button>
    </div>
  </div>

  <!-- Error Message -->
  @if (errorMessage()) {
  <div class="mb-4 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
    <div class="flex items-start gap-3">
      <i class="pi pi-exclamation-circle text-red-500 text-lg flex-shrink-0 mt-0.5"></i>
      <p class="text-sm text-red-300">{{ errorMessage() }}</p>
    </div>
  </div>
  }

  <!-- Existing Team Form -->
  @if (selectionMode() === 'existing') {
  <form [formGroup]="existingTeamForm" (ngSubmit)="onSubmitExistingTeam()" class="space-y-6">
    <!-- Team Selection -->
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">
        Select Team <span class="text-red-500">*</span>
      </label>
      @if (isLoadingTeams()) {
      <div class="flex items-center justify-center py-8">
        <i class="pi pi-spin pi-spinner text-2xl text-primary"></i>
      </div>
      } @else if (availableTeams().length === 0) {
      <div class="text-center py-8 border-2 border-dashed border-gray-700 rounded-lg">
        <i class="pi pi-users text-3xl text-gray-600 mb-2"></i>
        <p class="text-gray-400 text-sm">No teams available</p>
        <p class="text-gray-500 text-xs mt-1">Create a new team to get started</p>
      </div>
      } @else {
      <select
        formControlName="teamId"
        class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition"
      >
        <option value="" disabled selected>Choose a team...</option>
        @for (team of availableTeams(); track team.id) {
        <option [value]="team.id" class="bg-gray-800">
          {{ team.name }} @if (team.description) { - {{ team.description }} }
        </option>
        }
      </select>
      }
    </div>

    <!-- Project Roles -->
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-3">
        Project Roles <span class="text-red-500">*</span>
      </label>
      <div class="grid grid-cols-2 gap-3">
        @for (role of availableRoles; track role) {
        <button
          type="button"
          (click)="toggleRole(role, existingTeamForm)"
          [class.bg-primary]="isRoleSelected(role, existingTeamForm)"
          [class.border-primary]="isRoleSelected(role, existingTeamForm)"
          [class.text-primary]="isRoleSelected(role, existingTeamForm)"
          [class.bg-white]="!isRoleSelected(role, existingTeamForm)"
          [class.border-white]="!isRoleSelected(role, existingTeamForm)"
          [class.text-gray-300]="!isRoleSelected(role, existingTeamForm)"
          class="px-4 py-3 border rounded-lg font-medium transition hover:bg-primary/10 hover:border-primary/50 text-left"
        >
          <i
            [class.pi-check-circle]="isRoleSelected(role, existingTeamForm)"
            [class.pi-circle]="!isRoleSelected(role, existingTeamForm)"
            class="pi mr-2"
          ></i>
          {{ roleLabels[role] }}
        </button>
        }
      </div>
      @if (existingTeamForm.get('roles')?.touched && existingTeamForm.get('roles')?.invalid) {
      <p class="text-red-400 text-xs mt-2">Please select at least one role</p>
      }
    </div>

    <!-- Actions -->
    <div class="flex gap-3 pt-4">
      <button
        type="button"
        (click)="onClose()"
        class="flex-1 outer-button"
        [disabled]="isSubmitting()"
      >
        <i class="pi pi-times mr-2"></i>
        Cancel
      </button>
      <button
        type="submit"
        class="flex-1 inner-button"
        [disabled]="isSubmitting() || existingTeamForm.invalid || availableTeams().length === 0"
      >
        @if (isSubmitting()) {
        <i class="pi pi-spin pi-spinner mr-2"></i>
        Adding... } @else {
        <i class="pi pi-plus mr-2"></i>
        Add Team }
      </button>
    </div>
  </form>
  }

  <!-- New Team Form -->
  @if (selectionMode() === 'new') {
  <form [formGroup]="newTeamForm" (ngSubmit)="onSubmitNewTeam()" class="space-y-6">
    <!-- Team Name -->
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">
        Team Name <span class="text-red-500">*</span>
      </label>
      <input
        pInputText
        type="text"
        formControlName="name"
        placeholder="e.g., Frontend Team"
        class="w-full"
      />
      @if (newTeamForm.get('name')?.touched && newTeamForm.get('name')?.invalid) {
      <p class="text-red-400 text-xs mt-2">Team name must be at least 3 characters</p>
      }
    </div>

    <!-- Team Description -->
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-2">
        Description <span class="text-gray-500 text-xs">(Optional)</span>
      </label>
      <textarea
        pTextarea
        formControlName="description"
        placeholder="Brief description of the team's purpose..."
        rows="3"
        class="w-full"
      ></textarea>
    </div>

    <!-- Project Roles -->
    <div>
      <label class="block text-sm font-medium text-gray-300 mb-3">
        Project Roles <span class="text-red-500">*</span>
      </label>
      <div class="grid grid-cols-2 gap-3">
        @for (role of availableRoles; track role) {
        <button
          type="button"
          (click)="toggleRole(role, newTeamForm)"
          [class.bg-primary]="isRoleSelected(role, newTeamForm)"
          [class.border-primary]="isRoleSelected(role, newTeamForm)"
          [class.text-primary]="isRoleSelected(role, newTeamForm)"
          [class.bg-white]="!isRoleSelected(role, newTeamForm)"
          [class.border-white]="!isRoleSelected(role, newTeamForm)"
          [class.text-gray-300]="!isRoleSelected(role, newTeamForm)"
          class="px-4 py-3 border rounded-lg font-medium transition hover:bg-primary/10 hover:border-primary/50 text-left"
        >
          <i
            [class.pi-check-circle]="isRoleSelected(role, newTeamForm)"
            [class.pi-circle]="!isRoleSelected(role, newTeamForm)"
            class="pi mr-2"
          ></i>
          {{ roleLabels[role] }}
        </button>
        }
      </div>
      @if (newTeamForm.get('roles')?.touched && newTeamForm.get('roles')?.invalid) {
      <p class="text-red-400 text-xs mt-2">Please select at least one role</p>
      }
    </div>

    <!-- Info Box -->
    <div class="flex items-start gap-3 p-4 bg-primary/10 border border-primary/30 rounded-lg">
      <i class="pi pi-info-circle text-primary text-lg flex-shrink-0"></i>
      <p class="text-sm text-gray-300">
        The team will be created and immediately added to this project with the selected roles.
      </p>
    </div>

    <!-- Actions -->
    <div class="flex gap-3 pt-2">
      <button
        type="button"
        (click)="onClose()"
        class="flex-1 outer-button"
        [disabled]="isSubmitting()"
      >
        <i class="pi pi-times mr-2"></i>
        Cancel
      </button>
      <button
        type="submit"
        class="flex-1 inner-button"
        [disabled]="isSubmitting() || newTeamForm.invalid"
      >
        @if (isSubmitting()) {
        <i class="pi pi-spin pi-spinner mr-2"></i>
        Creating... } @else {
        <i class="pi pi-plus-circle mr-2"></i>
        Create & Add Team }
      </button>
    </div>
  </form>
  }
</p-dialog>
